// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. KULLANICI VE KİMLİK (USER & IDENTITY)
// ==========================================
model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?  @db.Text
  access_token       String?  @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?  @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

model User {
  id            String    @id @default(uuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  pendingEmail  String?   @unique // Stores the new email until verified
  image         String?
  password      String?   // Şifre (Hashlenmiş) - Credentials için

  // Custom Fields
  yahooId       String?   @unique // Legacy / Quick Access
  firstName     String?   // Gerçek Ad
  lastName      String?   // Gerçek Soyad
  birthDate     DateTime? // Doğum Tarihi
  username      String?
  avatarUrl     String?   // image ile senkronize tutulabilir veya ayrı
  bio           String?   // Profil yazısı

  // Ekonomi & İtibar
  credits       Int       @default(1000) // Sanal Para
  reputation    Int       @default(50)   // Güven Puanı (0-100)

  // İlişkiler
  accounts      Account[]
  sessions      Session[]
  
  teams         Team[]
  ledgers       Ledger[]      // Cüzdan Geçmişi
  salesHistory    TradeHistory[] @relation("SellerHistory")
  purchaseHistory TradeHistory[] @relation("BuyerHistory")
  notifications Notification[]
  
  // [YENİ] Alarm ve Analiz
  follows       PlayerFollow[] // Oyuncu Takipleri
  savedAnalyses SavedAnalysis[]   // Kaydedilen Raporlar

  // Sosyal
  sentRequests     Friendship[] @relation("Sender")
  receivedRequests Friendship[] @relation("Receiver")
  
  // Oyun İçi
  tradesInitiated  Trade[]      @relation("TradeInitiator")
  tradesReceived   Trade[]      @relation("TradeTarget")
  betsInitiated    Bet[]        
  betsReceived     Bet[]        @relation("BetOpponent")

  // İletişim
  messages         Message[]    // Gönderilen mesajlar
  comments         Comment[]    // Yazdığı yorumlar

    // Klan
  clanMembers      ClanMember[]
  ownedClans       Clan[]       @relation("ClanOwner")

  // Market
  listings         TradeListing[] @relation("Listings")
  offersMade       TradeOffer[]   @relation("OffersMade")

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// ==========================================
// 2. YAHOO SENKRONİZASYON VE GEÇMİŞ (SYNC ENGINE)
// ==========================================

// Oyun Tanımı (Örn: NBA 2024, NFL 2023)
model Game {
  id           String   @id // Yahoo Game Key (örn: "418")
  code         String   // "nba", "nfl"
  season       Int      // 2024
  leagues      League[]
  players      Player[]
}

model League {
  id             String   @id @default(cuid())
  yahooLeagueKey String   @unique
  gameId         String
  name           String
  numTeams       Int
  currentWeek    Int      @default(1)
  scoringType    String   // "head", "roto", "point"
  
  // Lig Ayarları (Hangi istatistikler kullanılıyor? JSON)
  settings     Json?    
  
  game         Game     @relation(fields: [gameId], references: [id])
  teams        Team[]
  matchups     Matchup[] // Fikstür ve Geçmiş
  messages     Message[] // Lig Sohbet Odası
  
  lastSync     DateTime  @default(now())
}

model Team {
  id             String   @id @default(cuid())
  yahooTeamKey   String   @unique
  leagueId       String
  managerId      String
  name           String
  logoUrl        String?
  
  // Puan Durumu
  wins         Int      @default(0)
  losses       Int      @default(0)
  ties         Int      @default(0)
  rank         Int?
  
  // Anlık Kadro (JSON olarak tutuyoruz)
  // [{ playerId: "nba.p.123", position: "PG", status: "ACT" }]
  roster       Json?    
  
  players      Player[] // Many-to-Many relation for roster

  league       League   @relation(fields: [leagueId], references: [id])
  manager      User     @relation(fields: [managerId], references: [id], onDelete: Cascade)
  
  // Eşleşmeler (Ev Sahibi / Deplasman)
  homeMatchups Matchup[] @relation("HomeTeam")
  awayMatchups Matchup[] @relation("AwayTeam")
}

// Haftalık Maçlar ve Geçmiş (Matchup History)
model Matchup {
  id           String   @id @default(uuid())
  leagueId     String
  week         Int      // Hangi Hafta?
  status       String   // "pre" (Başlamadı), "live" (Canlı), "finished" (Bitti - Geçmiş)
  
  teamAId      String
  teamBId      String
  teamAScore   Float    @default(0.0)
  teamBScore   Float    @default(0.0)
  winnerTeamId String?  // Maç bitince kazanan buraya yazılır
  
  teamA        Team     @relation("HomeTeam", fields: [teamAId], references: [id])
  teamB        Team     @relation("AwayTeam", fields: [teamBId], references: [id])
  league       League   @relation(fields: [leagueId], references: [id])
  
  bets         Bet[]    // Bu maça oynanan bahisler
  
  @@unique([leagueId, week, teamAId, teamBId]) 
}

// ==========================================
// 3. SPORCU BİLGİ VE ANALİZ (PLAYER HUB)
// ==========================================
model Player {
  id            String   @id // Yahoo Player Key (örn: "nba.p.3704")
  gameId        String   // Hangi oyun? (nba/nfl)
  fullName      String
  status        String?  // "Healthy", "IR", "GTD"
  editorialTeam String?  // "LAL", "GSW"
  photoUrl      String?
  
  primaryPos    String?  // "PG"
  
  // Stats
  fantasyPoints   Float    @default(0)
  projectedPoints Float    @default(0)
  percentStarted  Float?
  percentOwned    Float    @default(0)
  marketValue     Float    @default(0)
  opponent        String?
  
  // status field already exists above, but instructions asked to add it. 
  // It is already there: status String? // "Healthy", "IR", "GTD"
  // I will keep the existing one and just add the points.
  eligiblePos   Json?    // ["PG", "SG", "SF"]
  
  // Sezon Ortalamaları
  stats         Json?    // { "ppg": 25.4, "rpg": 8.2 }
  
  // İlişkiler
  game          Game            @relation(fields: [gameId], references: [id])
  teams         Team[]          // Many-to-Many relation for roster
  gameLogs      PlayerGameLog[] // Maç Maç Geçmiş Performans
  followers     PlayerFollow[]  // Kimler takipte?
  news          PlayerNews[]
  comments      Comment[]       // Sporcu yorumları
  
  // Market
  listings      TradeListing[]
  offeredIn     TradeOffer[]

  updatedAt     DateTime @updatedAt
}

model PlayerNews {
  id          String   @id @default(cuid())
  headline    String
  content     String?
  url         String?
  source      String?
  publishedAt DateTime
  createdAt   DateTime @default(now())
  
  playerId    String
  player      Player   @relation(fields: [playerId], references: [id])

  @@unique([playerId, headline])
  @@index([publishedAt])
}

// Oyuncu Maç Geçmişi (Grafikler için)
model PlayerGameLog {
  id           String   @id @default(uuid())
  playerId     String
  gameDate     DateTime
  opponent     String   // "vs BOS"
  stats        Json     // { points: 30, rebounds: 10 }
  
  player       Player   @relation(fields: [playerId], references: [id])
}

// Oyuncu Takip Sistemi
model PlayerFollow {
  id              String   @id @default(cuid())
  userId          String
  playerId        String
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  player          Player   @relation(fields: [playerId], references: [id])
  
  createdAt       DateTime @default(now())
  @@unique([userId, playerId])
}

// Kaydedilen Analiz Raporları
model SavedAnalysis {
  id          String   @id @default(uuid())
  userId      String
  title       String   // "LeBron vs Durant"
  type        String   // "PLAYER_COMPARE", "TEAM_COMPARE"
  
  entityAId   String
  entityBId   String
  
  resultData  Json     // Raporun sonucu (Cache)
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
}

// ==========================================
// 4. TAKAS VE PAZAR YERİ (TRADE CENTER)
// ==========================================
model Trade {
  id             String      @id @default(uuid())
  initiatorId    String
  targetUserId   String?     // Boşsa = MARKETPLACE (Herkese Açık)
  clanId         String?     // Doluysa = KLAN İÇİ
  
  scope          TradeScope  @default(DIRECT)
  
  // Takas Varlıkları (JSON)
  // [{ playerId: "...", type: "PLAYER" }, { amount: 500, type: "CREDIT" }]
  offeredAssets  Json        
  requestedAssets Json
  
  status         TradeStatus @default(OPEN)
  
  initiator      User        @relation("TradeInitiator", fields: [initiatorId], references: [id], onDelete: Cascade)
  targetUser     User?       @relation("TradeTarget", fields: [targetUserId], references: [id], onDelete: SetNull)
  clan           Clan?       @relation(fields: [clanId], references: [id])
  
  messages       Message[]   // Pazarlık Odası Sohbeti
  createdAt      DateTime    @default(now())
}

enum TradeScope {
  DIRECT
  MARKETPLACE
  CLAN
}

enum TradeStatus {
  OPEN
  NEGOTIATING
  ACCEPTED
  REJECTED
  CANCELLED
  EXPIRED
}

// ==========================================
// 5. BAHİS SİSTEMİ (BETTING ENGINE)
// ==========================================
model Bet {
  id           String    @id @default(uuid())
  userId       String    // Bahsi başlatan
  matchupId    String?   // Hangi maça?
  
  type         BetType
  selection    String    // "TeamA" veya "Over 200.5"
  odds         Float     // Oran (1.85)
  amount       Int       // Yatırılan miktar
  
  opponentId   String?   // P2P ise rakip kim?
  
  status       BetStatus @default(PENDING)
  winnerId     String?   // Kazanan User ID
  
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  opponent     User?     @relation("BetOpponent", fields: [opponentId], references: [id], onDelete: SetNull)
  matchup      Matchup?  @relation(fields: [matchupId], references: [id])
  
  createdAt    DateTime  @default(now())
}

enum BetType {
  MATCH_WINNER
  PROP_BET
  TOURNAMENT
  P2P_CHALLENGE
}

enum BetStatus {
  PENDING
  ACTIVE
  WON
  LOST
  CANCELLED
}

// ==========================================
// 6. SOHBET VE YORUM (SOCIAL LAYER)
// ==========================================
model Message {
  id           String   @id @default(uuid())
  content      String   @db.Text
  senderId     String
  
  // Hedef (Context)
  leagueId     String?
  clanId       String?
  tradeId      String?
  receiverId   String?  // DM
  
  sender       User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  league       League?  @relation(fields: [leagueId], references: [id])
  clan         Clan?    @relation(fields: [clanId], references: [id])
  trade        Trade?   @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  
  createdAt    DateTime @default(now())
}

model Comment {
  id            String   @id @default(cuid())
  content       String   @db.Text
  userId        String
  playerId      String
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  player        Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
}

// ==========================================
// 7. KLAN, LEDGER VE DİĞERLERİ
// ==========================================
model Clan {
  id          String       @id @default(uuid())
  name        String       @unique
  description String?
  logoUrl     String?
  treasury    Int          @default(0) // Klan Kasası
  level       Int          @default(1)
  
  ownerId     String
  owner       User         @relation("ClanOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  
  members     ClanMember[]
  messages    Message[]
  trades      Trade[]
}

model ClanMember {
  id        String   @id @default(uuid())
  userId    String
  clanId    String
  role      ClanRole @default(MEMBER)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  clan      Clan     @relation(fields: [clanId], references: [id], onDelete: Cascade)
  @@unique([userId, clanId])
}

enum ClanRole {
  LEADER
  OFFICER
  MEMBER
}

model Ledger {
  id           String   @id @default(uuid())
  userId       String
  amount       Int      // +500 veya -200
  type         String   // "BET_WIN", "TRADE_FEE", "DEPOSIT"
  description  String?  // "Lakers maçı bahsinden kazanç"
  referenceId  String?  // BetID veya TradeID
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
}

model Friendship {
  id         String @id @default(uuid())
  senderId   String
  receiverId String
  status     String @default("PENDING") // PENDING, ACCEPTED, BLOCKED
  
  sender     User   @relation("Sender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver   User   @relation("Receiver", fields: [receiverId], references: [id], onDelete: Cascade)
  @@unique([senderId, receiverId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // SYSTEM, TRADE, CLAN, INFO
  title     String
  message   String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
// ==========================================
// 5. MARKET (P2P TRADING)
// ==========================================

model TradeListing {
  id          String   @id @default(cuid())
  status      String   @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED
  notes       String?  // Seller's request: "Looking for a Center"
  createdAt   DateTime @default(now())

  // Who is selling what?
  sellerId    String
  seller      User     @relation("Listings", fields: [sellerId], references: [id])
  playerId    String
  player      Player   @relation(fields: [playerId], references: [id])

  // Offers received on this listing
  offers      TradeOffer[]
}

model TradeOffer {
  id          String   @id @default(cuid())
  status      String   @default("PENDING") // PENDING, ACCEPTED, REJECTED
  createdAt   DateTime @default(now())
  
  yahooTransactionId String? // Stores the Yahoo Transaction Key (e.g. 441.l.123.tr.45)

  // Who is offering?
  listingId   String
  listing     TradeListing @relation(fields: [listingId], references: [id])
  offererId   String
  offerer     User         @relation("OffersMade", fields: [offererId], references: [id])

  // The Offer Package (Multi-asset)
  offeredPlayerId String? // The player being offered in exchange
  offeredPlayer   Player? @relation(fields: [offeredPlayerId], references: [id])
  offeredCredits  Float   @default(0) // Optional sweetener
}

// 2. Trade History (Completed Swaps)
model TradeHistory {
  id          String   @id @default(cuid())
  sellerId    String
  buyerId     String
  seller      User     @relation("SellerHistory", fields: [sellerId], references: [id])
  buyer       User     @relation("BuyerHistory", fields: [buyerId], references: [id])
  
  assetsGiven Json     // Snapshot of players/credits given by Seller
  assetsReceived Json  // Snapshot of players/credits given by Buyer
  
  completedAt DateTime @default(now())
}

model YahooTransaction {
  id              String   @id @default(cuid())
  transactionKey  String   @unique // Yahoo ID (e.g. 423.l.123.tr.45)
  leagueId        String
  type            String   // "trade", "add", "drop", "commish"
  timestamp       DateTime
  
  // Store raw data for audit
  details         Json?    // Who moved where
  
  createdAt       DateTime @default(now())
}

// ==========================================
// YAHOO TRADE SYNC MODELS
// ==========================================

model YahooTrade {
  id            String   @id @default(cuid())
  yahooTradeId  String?  @unique // Nullable for local drafts
  leagueId      String
  status        String   // proposed, accepted, rejected
  offeredBy     String   // team_key
  offeredTo     String   // team_key
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  items         YahooTradeItem[]
}

model YahooTradeItem {
  id              String @id @default(cuid())
  tradeId         String
  trade           YahooTrade  @relation(fields: [tradeId], references: [id])
  playerKey       String
  senderTeamKey   String
  receiverTeamKey String
}

